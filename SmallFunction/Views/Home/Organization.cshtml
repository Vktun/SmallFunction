
@{
    ViewData["Title"] = "Organization";
}
<link href="~/lib/ztree/css/metroStyle/metroStyle.css" rel="stylesheet" />
<script src="~/lib/ztree/js/jquery.ztree.all.js"></script>
<style>
    #deparment, #deparment > div {
        height: 90%;
        min-height: 650px;
    }
</style>
<div class="row" id="deparment">
    <h3 class="text-center">hello</h3>
    <div class="col-sm-3">
        <ul id="treeDemo" class="ztree"></ul>
    </div>
    <div class="col-sm-9">

    </div>
</div>
<script>
    var MoveTest = {
        errorMsg: "放错了...请选择正确的类别！",
        curTarget: null,
        curTmpTarget: null,
        noSel: function () {
            try {
                window.getSelection ? window.getSelection().removeAllRanges() : document.selection.empty();
            } catch (e) { }
        },
        dragTree2Dom: function (treeId, treeNodes) {
            return !treeNodes[0].isParent;
        },
        prevTree: function (treeId, treeNodes, targetNode) {
            return !targetNode.isParent && targetNode.parentTId == treeNodes[0].parentTId;
        },
        nextTree: function (treeId, treeNodes, targetNode) {
            return !targetNode.isParent && targetNode.parentTId == treeNodes[0].parentTId;
        },
        innerTree: function (treeId, treeNodes, targetNode) {
            return targetNode != null && targetNode.isParent && targetNode.tId == treeNodes[0].parentTId;
        },
        dragMove: function (e, treeId, treeNodes) {
            var p = null, pId = 'dom_' + treeNodes[0].pId;
            if (e.target.id == pId) {
                p = $(e.target);
            } else {
                p = $(e.target).parent('#' + pId);
                if (!p.get(0)) {
                    p = null;
                }
            }

            $('.domBtnDiv .active').removeClass('active');
            if (p) {
                p.addClass('active');
            }
        },
        dropTree2Dom: function (e, treeId, treeNodes, targetNode, moveType) {
            var domId = "dom_" + treeNodes[0].getParentNode().id;
            if (moveType == null && (domId == e.target.id || $(e.target).parents("#" + domId).length > 0)) {
                var zTree = $.fn.zTree.getZTreeObj("treeDemo");
                zTree.removeNode(treeNodes[0]);

                var newDom = $("span[domId=" + treeNodes[0].id + "]");
                if (newDom.length > 0) {
                    newDom.removeClass("domBtn_Disabled");
                    newDom.addClass("domBtn");
                } else {
                    $("#" + domId).append("<span class='domBtn' domId='" + treeNodes[0].id + "'>" + treeNodes[0].name + "</span>");
                }
                MoveTest.updateType();
            } else if ($(e.target).parents(".domBtnDiv").length > 0) {
                alert(MoveTest.errorMsg);
            }
        },
        dom2Tree: function (e, treeId, treeNode) {
            var target = MoveTest.curTarget, tmpTarget = MoveTest.curTmpTarget;
            if (!target) return;
            var zTree = $.fn.zTree.getZTreeObj("treeDemo"), parentNode;
            if (treeNode != null && treeNode.isParent && "dom_" + treeNode.id == target.parent().attr("id")) {
                parentNode = treeNode;
            } else if (treeNode != null && !treeNode.isParent && "dom_" + treeNode.getParentNode().id == target.parent().attr("id")) {
                parentNode = treeNode.getParentNode();
            }

            if (tmpTarget) tmpTarget.remove();
            if (!!parentNode) {
                var nodes = zTree.addNodes(parentNode, { id: target.attr("domId"), name: target.text() });
                zTree.selectNode(nodes[0]);
            } else {
                target.removeClass("domBtn_Disabled");
                target.addClass("domBtn");
                alert(MoveTest.errorMsg);
            }
            MoveTest.updateType();
            MoveTest.curTarget = null;
            MoveTest.curTmpTarget = null;
        },
        updateType: function () {
            var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
                nodes = zTree.getNodes();
            for (var i = 0, l = nodes.length; i < l; i++) {
                var num = nodes[i].children ? nodes[i].children.length : 0;
                nodes[i].name = nodes[i].name.replace(/ \(.*\)/gi, "") + " (" + num + ")";
                zTree.updateNode(nodes[i]);
            }
        },
        bindDom: function () {
            $(".domBtnDiv").bind("mousedown", MoveTest.bindMouseDown);
        },
        bindMouseDown: function (e) {
            var target = e.target;
            if (target != null && target.className == "domBtn") {
                var doc = $(document), target = $(target),
                    docScrollTop = doc.scrollTop(),
                    docScrollLeft = doc.scrollLeft();
                target.addClass("domBtn_Disabled");
                target.removeClass("domBtn");
                curDom = $("<span class='dom_tmp domBtn'>" + target.text() + "</span>");
                curDom.appendTo("body");

                curDom.css({
                    "top": (e.clientY + docScrollTop + 3) + "px",
                    "left": (e.clientX + docScrollLeft + 3) + "px"
                });
                MoveTest.curTarget = target;
                MoveTest.curTmpTarget = curDom;

                doc.bind("mousemove", MoveTest.bindMouseMove);
                doc.bind("mouseup", MoveTest.bindMouseUp);
                doc.bind("selectstart", MoveTest.docSelect);
            }
            if (e.preventDefault) {
                e.preventDefault();
            }
        },
        bindMouseMove: function (e) {
            MoveTest.noSel();
            var doc = $(document),
                docScrollTop = doc.scrollTop(),
                docScrollLeft = doc.scrollLeft(),
                tmpTarget = MoveTest.curTmpTarget;
            if (tmpTarget) {
                tmpTarget.css({
                    "top": (e.clientY + docScrollTop + 3) + "px",
                    "left": (e.clientX + docScrollLeft + 3) + "px"
                });
            }
            return false;
        },
        bindMouseUp: function (e) {
            var doc = $(document);
            doc.unbind("mousemove", MoveTest.bindMouseMove);
            doc.unbind("mouseup", MoveTest.bindMouseUp);
            doc.unbind("selectstart", MoveTest.docSelect);

            var target = MoveTest.curTarget, tmpTarget = MoveTest.curTmpTarget;
            if (tmpTarget) tmpTarget.remove();

            if ($(e.target).parents("#treeDemo").length == 0) {
                if (target) {
                    target.removeClass("domBtn_Disabled");
                    target.addClass("domBtn");
                }
                MoveTest.curTarget = null;
                MoveTest.curTmpTarget = null;
            }
        },
        bindSelect: function () {
            return false;
        }
    };

    var setting = {
        edit: {
            enable: true,
            showRemoveBtn: false,
            showRenameBtn: false,
            drag: {
                prev: MoveTest.prevTree,
                next: MoveTest.nextTree,
                inner: MoveTest.innerTree
            }
        },
        data: {
            keep: {
                parent: true,
                leaf: true
            },
            simpleData: {
                enable: true
            }
        },
        callback: {
            beforeDrag: MoveTest.dragTree2Dom,
            onDrop: MoveTest.dropTree2Dom,
            onDragMove: MoveTest.dragMove,
            onMouseUp: MoveTest.dom2Tree,
        },
        view: {
            selectedMulti: false
        }
    };

    var zNodes = [
        { id: 1, pId: 0, name: "生物" },
        { id: 2, pId: 1, name: "植物"},
        { id: 3, pId: 1, name: "动物" },
        { id: 20, pId: 3, name: "大象" },
        { id: 29, pId: 3, name: "鲨鱼" },
        { id: 10, pId: 2, name: "大白菜" },
        { id: 19, pId: 2, name: "西红柿" }
    ];

    (function () {
        $.fn.zTree.init($("#treeDemo"), setting, zNodes);
        MoveTest.updateType();
        MoveTest.bindDom();
        var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
        treeObj.expandAll(true);
    })()
</script>